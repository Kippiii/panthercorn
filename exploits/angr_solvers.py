import pwn
import angr
import logging

logging.getLogger('angr').setLevel(logging.WARNING)


def parse_binary_name(binary):
    return binary.split('/')[-1]


def try_angr(binary, start=None, goal=None, avoid=None):
    elf = pwn.ELF(binary)
    pwn.context = elf
    p = angr.Project(binary)
    
    if not start:
        start = p.loader.find_symbol("main").rebased_addr
        
    if not goal:
        name = parse_binary_name(binary)
        if 'ret2syscall' in name:
            goal = p.loader.find_symbol("func").rebased_addr
        elif 'ret2system' in name:
            goal = [p.loader.find_symbol('closing_func').rebased_addr, p.loader.find_symbol("cmd_func")]
        elif 'ret2execve' in name:
            goal = p.loader.find_symbol("func").rebased_addr
        elif "ret2one" in name:
            goal = p.loader.find_symbol("vuln").rebased_addr
        elif "ret2win" in name:
            goal = p.loader.find_symbol("win").rebased_addr

    init_state = p.factory.entry_state(
        add_options=angr.options.unicorn,
        addr=start
    )
    simulation = p.factory.simgr(init_state)
    simulation.explore(n=100000000, find=goal, avoid=avoid)

    if simulation.found:
        solution = simulation.found[0]
        return solution.posix.dumps(0)
    else:
        # print(simulation.unconstrained[0].posix.dumps(0))
        return False
